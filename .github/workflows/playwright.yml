name: Playwright Tests
run-name: "Termeet Playwright Tests"

on:
  pull_request:
    branches: 
      - main

jobs:
  test:
    strategy:
      matrix:
        test-type: [components, e2e]
        include:
          - test-type: components
            command: pwt:test
          - test-type: e2e
            command: pwt:e2e:test
      fail-fast: true
    runs-on: ubuntu-latest
    env:
      PR_NUMBER: ${{ github.event.number }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - uses: ./.github/actions/custom-preparing-action
          
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install Playwright Browsers
        run: pnpm exec playwright install --with-deps
        
      - name: Run tests
        id: run-tests
        continue-on-error: true
        run: |
          rm -rf playwright/.cache
          rm -rf test-results
          npx playwright clear-cache
          pnpm run ${{ matrix.command }}

      # –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç—ã –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã —É–ø–∞–ª–∏
      - name: Update screenshots
        id: update-screens
        if: steps.run-tests.outcome == 'failure'
        run: |
          pnpm run ${{ matrix.command }} --update-snapshots
          echo "SCREENSHOTS_UPDATED=true" >> $GITHUB_OUTPUT

      # –ö–æ–º–º–∏—Ç–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã
      - name: Commit updated screenshots
        if: steps.update-screens.outputs.SCREENSHOTS_UPDATED == 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã
          git add -A
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          if git diff --staged --quiet; then
            echo "No screenshots to update"
          else
            git commit -m "chore: update playwright screenshots [skip ci]"
            git push
          fi

      # –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤
      - name: Comment PR on screenshot update
        if: steps.update-screens.outputs.SCREENSHOTS_UPDATED == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const testType = '${{ matrix.test-type }}';
            const body = `## üñºÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω—ã —Å–∫—Ä–∏–Ω—à–æ—Ç—ã Playwright!

            **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏–ª —Å–∫—Ä–∏–Ω—à–æ—Ç—ã –¥–ª—è \`${testType}\` —Ç–µ—Å—Ç–æ–≤.**

            **–ß—Ç–æ –¥–∞–ª—å—à–µ:**
            - ‚úÖ –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã –≤—ã–≥–ª—è–¥—è—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
            
            > ‚ö†Ô∏è –ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ, –ø—Ä–æ–≤–µ—Ä—å –∫–æ–¥!`;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
      - name: Comment PR on success
        if: steps.run-tests.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const testType = '${{ matrix.test-type }}';
            const body = `## ‚úÖ ${testType} —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!`;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });